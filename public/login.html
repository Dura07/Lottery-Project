<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="assets/css/auth.css">
    <link rel="stylesheet" href="assets/css/style.css">

    <script type="module" src="assets/js/auth.js"></script>
</head>
<body>

  <header class="header">
    <div class="logo"><a href="index.html"><img src="assets/images/redCrownLogo.png" alt=""></a></div>
    </header>
  <main class="auth-card" role="main" aria-labelledby="loginTitle">
    <h2 id="loginTitle">Login</h2>

    <div id="loginMessage" class="message"></div>

    <form id="loginForm" novalidate>
      <div class="form-row">
        <input id="loginPhone" name="phone" type="tel" placeholder="Telephone Number (e.g. +2348012345678)" required />
      </div>

      <div class="form-row input-with-toggle">
        <input id="loginPassword" name="password" type="password" placeholder="Password" required />
        <button type="button" class="toggle-btn" id="toggleLoginPwd">Show</button>
      </div>

      <div class="form-options">
      <label class="remember-me">
        <input type="checkbox" id="rememberMe">
        <span>Remember me</span>
      </label>
      <a href="forgot-password.html" class="forgot-link">Forgot Password?</a>
    </div>

    <button class="btn-primary" type="submit">Login</button>
  </form>

  <div class="auth-footer">
    <button class="switch-btn" onclick="location.href='register.html'">Create an account</button>
  </div>
  </main>


  
  <script type="module">
    const loginForm = document.getElementById('loginForm');
    const loginMessage = document.getElementById('loginMessage');
    const loginPhone = document.getElementById('loginPhone');
    const loginPassword = document.getElementById('loginPassword');

    // Password toggle logic
    const toggleBtn = document.getElementById('toggleLoginPwd');
    toggleBtn.addEventListener('click', () => {
      loginPassword.type = loginPassword.type === 'password' ? 'text' : 'password';
      toggleBtn.innerText = loginPassword.type === 'password' ? 'Show' : 'Hide';
    });

    // Form submit logic
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const phone = loginPhone.value.trim();
      const password = loginPassword.value;

      if (!phone || !password) {
        loginMessage.innerText = "Please fill in all fields.";
        loginMessage.style.color = "red";
        return;
      }

      // MATCHING LOGIC: We use the same @pm-lotto.com suffix used in registration
      const virtualEmail = `${phone}@pm-lotto.com`;

      loginMessage.innerText = "Authenticating...";
      loginMessage.style.color = "blue";

      // Call the function exposed to the window by auth.js
      if (typeof window.loginUser === "function") {
        try {
          // window.loginUser in your auth.js already handles the redirect to dashboard.html
          await window.loginUser(virtualEmail, password);

          // If loginUser doesn't redirect automatically, we do it here:
          loginMessage.innerText = "Login successful!";
          loginMessage.style.color = "green";
        } catch (err) {
          loginMessage.innerText = "Error: " + err.message;
          loginMessage.style.color = "red";
        }
      } else {
        loginMessage.innerText = "Auth system loading, please wait...";
        loginMessage.style.color = "orange";
      }
    });


    // 1. When the page loads, check if a phone was saved
window.addEventListener('DOMContentLoaded', () => {
    const savedPhone = localStorage.getItem('rememberedPhone');
    if (savedPhone) {
        document.getElementById('loginPhone').value = savedPhone;
        document.getElementById('rememberMe').checked = true;
    }
});

// 2. Inside your loginForm 'submit' event listener:
const rememberMe = document.getElementById('rememberMe').checked;
if (rememberMe) {
    localStorage.setItem('rememberedPhone', phone);
} else {
    localStorage.removeItem('rememberedPhone');
}
  </script>
</body>
</html>