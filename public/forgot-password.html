<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forgot Password - PM Lotto</title>
  <link rel="stylesheet" href="assets/css/auth.css">
  <script type="module" src="assets/js/auth.js"></script>
</head>
<body>
  <main class="auth-card" role="main">
    <h2 id="resetTitle">Reset Password</h2>
    <p class="lead">Enter your phone number to receive a password reset link.</p>

    <div id="resetMessage" class="message"></div>

    <form id="forgotForm" novalidate>
      <div class="form-row">
        <input id="resetPhone" name="phone" type="tel" placeholder="Telephone (e.g. 08012345678)" required />
      </div>

      <button class="btn-primary" type="submit" id="submitBtn">Send Reset Link</button>
    </form>

    <div class="auth-footer">
      <a href="login.html" class="switch-btn">Back to Login</a>
    </div>
  </main>

  <script type="module">
    // We import the specific Firebase function here to handle the reset
    import { auth } from "./assets/js/firebaseauth.js";
    import { sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const forgotForm = document.getElementById('forgotForm');
    const messageDiv = document.getElementById('resetMessage');
    const submitBtn = document.getElementById('submitBtn');

    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const phone = document.getElementById('resetPhone').value.trim();
      
      if (!phone) {
        messageDiv.innerText = "Please enter your phone number.";
        messageDiv.style.color = "red";
        return;
      }

      // CRITICAL: Must match the exact format used in your registration/login
      const virtualEmail = `${phone}@pm-lotto.com`;

      // UI Feedback
      submitBtn.disabled = true;
      submitBtn.innerText = "Processing...";
      messageDiv.innerText = "";

      try {
        await sendPasswordResetEmail(auth, virtualEmail);
        
        messageDiv.innerText = "Success! If this number is registered, you will receive a reset link shortly.";
        messageDiv.style.color = "green";
        forgotForm.reset();
        
      } catch (error) {
        console.error("Reset Error:", error.code);
        
        // Friendly error messages
        if (error.code === 'auth/user-not-found') {
          messageDiv.innerText = "This phone number is not registered.";
        } else if (error.code === 'auth/too-many-requests') {
          messageDiv.innerText = "Too many attempts. Please try again later.";
        } else {
          messageDiv.innerText = "Error: " + error.message;
        }
        messageDiv.style.color = "red";
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = "Send Reset Link";
      }
    });
  </script>
</body>
</html>